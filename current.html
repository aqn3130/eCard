<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script
    src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
    integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g="
    crossorigin="anonymous"></script>

<style>
input[type=text],#div1{
    width: inherit;
    padding: 12px 20px;
    margin: 8px 0;
    display: list-item;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;

}
select{
    width: auto;
    padding: 12px 20px;
    margin: 8px 0;
    display: list-item;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
}
.button {
  display: inline-block;
  padding: 8px 8px;
  font-size: 16px;
  cursor: pointer;
  text-align: center;
  text-decoration: none;
  outline: none;
  color: #fff;
  background-color: #0088cc;
  border: none;
  border-radius: 4px;
  box-shadow: 0 1px #999;
}

.button:hover {background-color: #0077cc}

.button:active {
  background-color: #0088cc;
  box-shadow: 0 0px #666;
  transform: translateY(3px);
}

label{
  color: black;
}
details {
    display: list-item;
}
#editor1 {
      height: 40px;
      width: 590px;
      position: absolute;
      left: auto;
      padding: 12px 20px;
      margin: 8px 0;
      display: block;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      overflow: hidden;
      resize: none;
      white-space: nowrap;
     }
#sig{
    height: 60px;
      width: 590px;
      position: absolute;
      left: auto;
      padding: 12px 20px;
      margin: 8px 0;
      display: block;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      overflow: hidden;
      resize: none;
      white-space: nowrap;
}
#editor2 {
    height: 200px;
    width: 590px;
    position: absolute;
    left: auto;
    padding: 12px 20px;
    margin: 8px 0;
    display:block;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
    overflow: hidden;
    white-space: normal;
    }
</style>

</head>

<body>

<div id="div1" class="container">
   
    <label for="colourFonts">Font Colour</label>
    <select class="colourF" name="colourFonts" onchange="changeFontColour()" style="display:inline">
      <option value="#486a7e">Dark</option>
      <option value="#cedbe0" selected>White</option>
      <option value="Gold">Gold</option>
      <option value="Orange">Orange</option>
    </select>

    <label for="fontSize">Font Size</label>
    <select id="fSize" name="fontSize" class="8-14" style="display:inline" onchange="changeFontSize()">
            <option value="10">10</option>
            <option value="14" selected>14</option>
    </select>
    <hr>

    <label for="title">Title</label>
    <div id="editor1" name="title" contenteditable="true"></div>

    <br /><br /><br /><br />

    <label for="message">Message</label>
    <div id="editor2" name="message" contenteditable="true"></div>

    <br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />

    <label for="signature">Signature</label>
    <div id="sig" name="signature" contenteditable="true"></div>

    <br /><br /><br /><br /><br />

    <button class="button" type="button" display="inline" onclick="makeIt()">Add Content</button>
    <label for="charCount" display="inline" style="position:absolute;left:410px;top:450px;font-size:9px">Max 700 Characters</label>
    <label id="charCount" display="" style="position:absolute;left:530px;top:450px;font-size:9px"></label>
    
    <br><br>

    <!-- <details style="font-size:12px">
      <summary>Follow the steps below to finalise your eCard</summary>
      <ul>
        <li>Save - Right click the eCard and select Save</li>
        <li>Edit - Edit text then Add Content again</li>
        <li>Error - If content not showing in eCard remove empty spaces using backspace</li>
        <li>Browser - For best result use Chrome or Firefox on Mac and Windows</li>
        <li>Email - Compose a new mail and either attach or insert saved eCard from step-1</li>
        <li>Print - Open eCard by double clicking saved file from step-1 then print</li>
      </ul>
    </details> -->

    <label for ="help" style="font-family:Myriad,Verdana,Arial"><b>Follow the steps below to finalise your eCard</b></label>
    <ul name="help" style="font-family:Myriad,Verdana,Arial;font-size:12px">
        <li>Save - Right click the eCard and select Save</li>
        <li>Edit - Edit text then Add Content again</li>
        <li>Error - If content not showing in eCard remove empty spaces using backspace</li>
        <li>Browser - For best result use Chrome or Firefox on Mac and Windows</li>
        <li>Email - Compose a new mail and either attach or insert saved eCard from step-1</li>
        <li>Print - Open eCard by double clicking saved file from step-1 then print</li>
    </ul>

</div>

<canvas id="cardCanvas" width="590" height="500">
Your browser does not support the HTML5 canvas tag.</canvas>

<script>
    var images = [];
    var c = document.getElementById("cardCanvas");
    var ctx = c.getContext("2d");
    var isCaps = false;

    //Preloading eCards
    $(function()
    {
        function preload()
        {
            for (var i = 0; i < arguments.length; i++) {
                images[i] = new Image();
                images[i].src = preload.arguments[i];
                
            }   
        }
        preload(
            "https://hive.springernature.com/resources/statics/134902/eCard_dark.png?a=1511468512813",
            "https://hive.springernature.com/resources/statics/134902/eCard_dark_large.png?a=1511468503588"
        )
        //Add character count and re-add content after text edit
        $("#editor2,#editor1,#sig").on("keyup",function(){
            changeCard();      
        });
        $("#editor2").on("keyup",function(){

            $("#charCount").text($("#editor2").text().length)
            var newSize = $(".8-14 option:checked").val();
            if(newSize === "14"){
            $("#editor2").css("line-height", 18+"pt");
            // console.log(document.getElementById("editor2").style.lineHeight);
            }
            else{
                $("#editor2").css("line-height", 13+"pt");
                // console.log(document.getElementById("editor2").style.lineHeight);
            }
        });
    });

    //Load eCard after 1 second after loading page
    setTimeout(function(){
        c.height=500;
        ctx.drawImage(images[0],0,0);
    },1000);

    //Building eCard using canvas and svg
    function makeIt()
    {
        var title = $("#editor1").html().replace(/&nbsp;/g,'');
        var message = $("#editor2").html().replace(/&nbsp;/g,'');
        var signiture = $("#sig").html().replace(/&nbsp;/g,'');
        ctx.fillStyle = "#cedbe0";

        var f = "Daytona light";
        var data = 
        '<svg xmlns="http://www.w3.org/2000/svg" width="520" height="200">' +
        '<foreignObject width="100%" height="100%">' +
        '<div xmlns="http://www.w3.org/1999/xhtml" >' +
        '<span style="color:#cedbe0; font-size:14px; white-space:nowrap; font-family:Myriad,Verdana,Arial">' +
        title+'</span>' +
        '</div>' +
        '</foreignObject>' +
        '</svg>';

        var data2 = 
        '<svg xmlns="http://www.w3.org/2000/svg" width="520" height="200">' +
        '<foreignObject width="100%" height="100%">' +
        '<div xmlns="http://www.w3.org/1999/xhtml">' +
        '<span style="color:#cedbe0; font-size:14px; white-space:normal; font-family:Myriad,Verdana,Arial">' +
        message+'</span>' +
        '</div>' +
        '</foreignObject>' +
        '</svg>';

        var data3 = 
        '<svg xmlns="http://www.w3.org/2000/svg" width="520" height="200">' +
        '<foreignObject width="100%" height="100%">' +
        '<div xmlns="http://www.w3.org/1999/xhtml">' +
        '<span style="color:#cedbe0; font-size:14px; white-space:nowrap; font-family:Myriad,Verdana,Arial">' +
        signiture+'</span>' +
        '</div>' +
        '</foreignObject>' +
        '</svg>';

        var DOMURL = window.URL || window.webkitURL || window;
        var img1 = new Image();
        var svg1 = new Blob([data], {type: 'image/svg+xml'});
        var url1 = DOMURL.createObjectURL(svg1);

        img1.onload = function() 
        {
            ctx.drawImage(img1, 35, 265);
            DOMURL.revokeObjectURL(url1);
        }
        var img2 = new Image();
        var svg2 = new Blob([data2], {type: 'image/svg+xml'});
        var url2 = DOMURL.createObjectURL(svg2);
        
        img2.onload = function() 
        {
            ctx.drawImage(img2, 35, 295);
            DOMURL.revokeObjectURL(url2);
        }

        var img3 = new Image();
        var svg3 = new Blob([data3], {type: 'image/svg+xml'});
        var url3 = DOMURL.createObjectURL(svg3);
        img3.onload = function() 
        {
            if(isCaps===true || $("#editor2").text().length>302){
                ctx.drawImage(img3, 35, 525);
                DOMURL.revokeObjectURL(url3);
            }
            else{
                ctx.drawImage(img3, 35, 385);
                DOMURL.revokeObjectURL(url3);
            }  
        }
        img1.src = url1;
        img2.src = url2;
        img3.src = url3;
    }
    //Changing font size
    function changeFontSize(){
        var newSize = $(".8-14 option:checked").val();
        document.execCommand("fontSize", false, "7");
        var fontElements = document.getElementsByTagName("font");
        for (var i = 0, len = fontElements.length; i < len; ++i) {
            if (fontElements[i].size == "7") {
                fontElements[i].removeAttribute("size");
                fontElements[i].style.fontSize = newSize+"px";
            }
        } 
        changeCard(); 
    }

    //Changing font colour
    function changeFontColour(){
        var newColour = $(".colourF option:checked").val();
        document.execCommand("foreColor", false, newColour);
        changeCard();
    }

    //Prevent blank line in message box blank line not supported in svg
    var iteration = 1;
    var z = $("#editor2").text().length;
    var returnKeyClicked = 0;
    $("#editor2").keypress(function(event)
    {
        if(event.which === 13){
            returnKeyClicked++;
            
                if(returnKeyClicked >=5){
                    if($("#editor2").text().length<302){
                    event.preventDefault();
                    }
                }

                if(returnKeyClicked >= 18){
                    if($("#editor2").text().length>302){
                        event.preventDefault();
                    }
                }

            
            

            if($("#editor2").text().length > 0){
                if(iteration === 1 && $("#editor2").text().length != z){
                    iteration++;   
                    z = $("#editor2").text().length;
                }
                else{
                    event.preventDefault(); 
                    if(iteration != 1){
                        iteration = 1;  
                    }  
                } 
            }
            else{
                event.preventDefault(); 
                if(iteration != 1){
                    iteration = 1;  
                }
            }  
        }
    });

    //Disable return key for Title and Signiture
    $("#editor1").keypress(function(event){
        if (event.which == '13') {
            event.preventDefault();
        }
    });

    //Prevent more than one blank line in signiture box
    var sigLine = 1;
    var y = $("#sig").text().length;
    $("#sig").keypress(
        function(event){
        if(event.which === 13){
            if($("#sig").text().length > 0 ){
                if(sigLine === 1 && $("#sig").text().length != y){
                    sigLine++;   
                    y = $("#sig").text().length; 
                }
                else{
                    event.preventDefault(); 
                    if(sigLine != 1){ 
                    }  
                } 
            }
            else{
                event.preventDefault(); 
                if(sigLine != 1){
                }
            }  
        }
    });

    //Character limit for div-1
    $("#editor1").on("keydown",function(event) {
        // $('span').text('Total chars:' + $(this).text().length);
        if($(this).text().length > 50 && event.keyCode != 8) {
            event.preventDefault();
        }
    });
    //Character limit for div-2
    $("#editor2").on("keydown", function(event) {
        // $('span').text('Total chars:' + $(this).text().length);
        if(isCaps===false){
                if($(this).text().length === 700 && event.keyCode != 8) {
                event.preventDefault();
            } 
        }
        else{
            if($(this).text().length === 500 && event.keyCode != 8) {
                event.preventDefault();
            }
        }  
    });
    //Limit Signiture character length
    $("#sig").on("keydown",function(event) {
        // $('span').text('Total chars:' + $(this).text().length);
        if($(this).text().length > 70 && event.keyCode != 8) {
            event.preventDefault();
        }
    });
    //Check if caps lock is on
    $(function(){
        $("#editor2").keypress(function(e) {
            var kc = e.which; //get keycode
            var isUp = (kc >= 65 && kc <= 90) ? true : false; // uppercase
            var isLow = (kc >= 97 && kc <= 122) ? true : false; // lowercase
            // event.shiftKey does not seem to be normalized by jQuery(?) for IE8-
            var isShift = ( e.shiftKey ) ? e.shiftKey : ( (kc == 16) ? true : false ); // shift is pressed
        
            // uppercase w/out shift or lowercase with shift == caps lock
            if ( (isUp && !isShift) || (isLow && isShift) ) {
                isCaps = true;
            }
        
        });
    });

    //Switch card for large messages
    function changeCard(){
        if(isCaps===true || $("#editor2").text().length>302){
            c.height=645;
            ctx.drawImage(images[1],0,0);
        }
        else{
            c.height=500;
            ctx.drawImage(images[0],0,0);
        }
    }

</script>
</body>
</html>
